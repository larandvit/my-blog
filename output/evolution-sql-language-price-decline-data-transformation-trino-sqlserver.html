<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml"><head><title>Evolution of SQL Language with Price Decline Data Transformation in Trino and SQL Server - tech jogging</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="A personal blog includes technical articles aimed to share knowledge and experience with others."><link rel="canonical" href="https://techjogging.com/evolution-sql-language-price-decline-data-transformation-trino-sqlserver.html"><meta name="author" content="Vitaly Saversky"><meta name="description" content="SQL language is the most loved and supported language to work with data. It goes back in the early 1970s when it first hit the ground running. Since that time, the language has been developing with fast pace. The latest language standard is SQL 2016 which includes a great deal …"><meta property="og:site_name" content="tech jogging"><meta property="og:type" content="article"><meta property="og:title" content="Evolution of SQL Language with Price Decline Data Transformation in Trino and SQL Server"><meta property="og:url" content="https://techjogging.com/evolution-sql-language-price-decline-data-transformation-trino-sqlserver.html"><meta property="og:description" content="SQL language is the most loved and supported language to work with data. It goes back in the early 1970s when it first hit the ground running. Since that time, the language has been developing with fast pace. The latest language standard is SQL 2016 which includes a great deal …"><meta property="article:published_time" content="2022-02-19"><meta property="article:section" content="Trino(Presto)"><meta property="article:author" content="Vitaly Saversky"><link rel="stylesheet" href="https://techjogging.com/theme/css/bootstrap.flatly.min.css" type="text/css"><link href="https://techjogging.com/theme/css/font-awesome.min.css" rel="stylesheet"><link href="https://techjogging.com/theme/css/pygments/monokai.css" rel="stylesheet"><link href="https://techjogging.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet"><link rel="stylesheet" href="https://techjogging.com/theme/css/style.css" type="text/css"></head><body><div class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="https://techjogging.com/" class="navbar-brand"><img alt="tech jogging" class="img-responsive pull-left gap-right" src="https://techjogging.com/extra/site-logo.png" width> tech jogging </a></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li><a href="https://techjogging.com/pages/about-blog.html"> About blog </a></li></ul><ul class="nav navbar-nav navbar-right"><li><span><form class="navbar-search" action="/search.html"><input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" pattern=".{3,}" title="At least 3 characters" required><button type="submit" class="tipue_search_button"><div class="tipue_search_icon">&#9906;</div></button></form></span></li></ul></div></div></div><div class="container"><div class="row"><div class="col-sm-9"><section id="content"><article><header class="page-header"><h1><a href="https://techjogging.com/evolution-sql-language-price-decline-data-transformation-trino-sqlserver.html" rel="bookmark" title="Permalink to Evolution of SQL Language with Price Decline Data Transformation in Trino and SQL Server"> Evolution of SQL Language with Price Decline Data Transformation in Trino and SQL Server </a></h1></header><div class="entry-content"><div class="panel"><div class="panel-body"><footer class="post-info"><span class="label label-default">Date</span><span class="published article-info-label"><i class="fa fa-calendar"></i><time datetime="2022-02-19T00:00:00-05:00"> 2022-02-19</time></span><span class="label label-default pageviews">Views</span><span class="article-info-label pageviews"><span class="badge pageviews" id="query-output"></span></span><span class="label label-default">Category</span><span class="article-info-label"><a href="https://techjogging.com/category/trinopresto.html">Trino(Presto)</a>, <a href="https://techjogging.com/category/ms-sql-server.html">MS SQL Server</a></span></footer></div></div><p>SQL language is the most loved and supported language to work with data. It goes back in the early 1970s when it first hit the ground running. Since that time, the language has been developing with fast pace. The latest language standard is SQL 2016 which includes a great deal of new features.</p><p>Data transformation is well supported by SQL language. Price decline is one of the transformation topics used in recovery audit. Source data which contains a snapshot of prices in time is transformed into short form where extracted only moments of time with price decreases. It can be achieved with comparing previous price with current one in a loop. </p><p>The evolution of SQL language can be represented with price decline transformation. The transformation might be done by means of different techniques and SQL language helps in it perfectly. It will be considered 3 different methods to accomplish the price decline transformation. Each method shows improvements in SQL language. We start from the oldest, slowest, and time-consuming process and finish with the latest way included in SQL 2016 standard. I would say that the latest one is not easy to understand comparing with the oldest one which is the way how people naturally proceed with data transformation.</p><p><a href="https://www.starburst.io">Starburst 369-e</a> distribution of <a href="https://trino.io/">Trino</a> and <a href="https://www.microsoft.com/en-us/sql-server/sql-server-2019">Microsoft SQL Server 2019</a> are used as SQL engines to transform data.</p><h2>Source data</h2><p>There are 2 different customers who have ordered an item.</p><p><img alt="Source data" src="https://techjogging.com/images/evolution-sql-language-price-decline-data-transformation-trino-sqlserver/source-data.jpg"></p><h2>Data transformation result</h2><p>The output is partitioned by customers, so each customer has his/her price changes.</p><p><img alt="Data transformation result" src="https://techjogging.com/images/evolution-sql-language-price-decline-data-transformation-trino-sqlserver/data-transformation-result.jpg"></p><h2>Cursor</h2><p>The sample is developed only in Microsoft SQL Server as Trino doesn't support cursors and structured programming.</p><p>The first step is to sort data, and then loop through data comparing customer_id and the previous price with the current one. If the current price is less than previous one, this record is stored in an output table. As you can see, we need to create multiple variables and an output table. Also, <code>WHILE</code> and <code>IF</code> structure control calculation logic.</p><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">CustomerID</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="o">@</span><span class="n">OrderDate</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">,</span> <span class="o">@</span><span class="n">Price</span> <span class="k">AS</span> <span class="nb">INTEGER</span><span class="p">;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">CurrentCustomerID</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="o">@</span><span class="n">CurrentOrderDate</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">,</span> <span class="o">@</span><span class="n">CurrentPrice</span> <span class="k">AS</span> <span class="nb">INTEGER</span><span class="p">;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">tblResult</span> <span class="k">AS</span> <span class="k">TABLE</span><span class="p">(</span><span class="n">customer_id</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">old_price</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">old_price_date</span> <span class="nb">DATE</span><span class="p">,</span> <span class="n">new_price</span> <span class="nb">INTEGER</span><span class="p">,</span> <span class="n">price_decrease_date</span> <span class="nb">DATE</span><span class="p">,</span> <span class="n">difference</span> <span class="nb">INTEGER</span><span class="p">);</span>

<span class="k">DECLARE</span> <span class="n">cur_orders</span> <span class="k">CURSOR</span> <span class="k">FOR</span>
<span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="p">(</span><span class="k">VALUES</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-11&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-12&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">200</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-13&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">8</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-14&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-15&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-16&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>  <span class="mi">50</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-17&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-18&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-20&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">3</span><span class="p">))</span> <span class="k">AS</span> <span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">order_date</span><span class="p">;</span>

<span class="k">SET</span> <span class="o">@</span><span class="n">CurrentCustomerID</span><span class="o">=</span><span class="k">NULL</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="o">=</span><span class="mi">999999999</span><span class="p">;</span>

<span class="k">OPEN</span> <span class="n">cur_orders</span><span class="p">;</span>

<span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">cur_orders</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">CustomerID</span><span class="p">,</span> <span class="o">@</span><span class="n">OrderDate</span><span class="p">,</span> <span class="o">@</span><span class="n">Price</span><span class="p">;</span>
<span class="n">WHILE</span> <span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">BEGIN</span>

    <span class="k">IF</span> <span class="o">@</span><span class="n">CurrentCustomerID</span><span class="o">=@</span><span class="n">CustomerID</span>
    <span class="k">BEGIN</span>
        <span class="k">IF</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="o">&gt;@</span><span class="n">Price</span>
        <span class="k">BEGIN</span>
            <span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">tblResult</span> <span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">old_price</span><span class="p">,</span> <span class="n">old_price_date</span><span class="p">,</span> <span class="n">new_price</span><span class="p">,</span> <span class="n">price_decrease_date</span><span class="p">,</span> <span class="n">difference</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="o">@</span><span class="n">CustomerID</span><span class="p">,</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="p">,</span> <span class="o">@</span><span class="n">CurrentOrderDate</span><span class="p">,</span> <span class="o">@</span><span class="n">Price</span><span class="p">,</span> <span class="o">@</span><span class="n">OrderDate</span><span class="p">,</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="o">-@</span><span class="n">Price</span><span class="p">);</span>
        <span class="k">END</span>

        <span class="k">SET</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="o">=@</span><span class="n">Price</span><span class="p">;</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">CurrentOrderDate</span><span class="o">=@</span><span class="n">OrderDate</span><span class="p">;</span>
    <span class="k">END</span> 
    <span class="k">ELSE</span>
    <span class="k">BEGIN</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">CurrentCustomerID</span><span class="o">=@</span><span class="n">CustomerID</span><span class="p">;</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">CurrentPrice</span><span class="o">=@</span><span class="n">Price</span><span class="p">;</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">CurrentOrderDate</span><span class="o">=@</span><span class="n">OrderDate</span><span class="p">;</span>
    <span class="k">END</span>

    <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">cur_orders</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">CustomerID</span><span class="p">,</span> <span class="o">@</span><span class="n">OrderDate</span><span class="p">,</span> <span class="o">@</span><span class="n">Price</span>
<span class="k">END</span><span class="p">;</span>

<span class="k">CLOSE</span> <span class="n">cur_orders</span><span class="p">;</span>
<span class="k">DEALLOCATE</span> <span class="n">cur_orders</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="o">@</span><span class="n">tblResult</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">old_price_date</span><span class="p">;</span>
</pre></div><h2>Recursive SQL statement</h2><p>SQL Server and Trino statements are identical. The difference is how a source table is created.</p><p>There are 2 <code>SELECT</code> statements inside of <code>WITH</code> clause. The first statement is called an anchor or a recursive base and the second one is called a recursive member or a recursion step. The terminology is taken from corresponding documentation. The anchor is starting point of a recursion. The recursive member is the recursion definition. The logic requests to create an addition "id" field.</p><ul><li><p>SQL Server</p><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">project</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span>
       <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">order_date</span><span class="p">)</span> <span class="k">AS</span> <span class="n">id</span>
<span class="k">INTO</span> <span class="n">project</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">orders</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">VALUES</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-11&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-12&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">200</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-13&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">8</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-14&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-15&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-16&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>  <span class="mi">50</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-17&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-18&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-20&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">3</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="n">price</span><span class="p">);</span>

<span class="k">WITH</span> <span class="n">t</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">old_price</span><span class="p">,</span> <span class="n">old_order_date</span><span class="p">,</span> <span class="n">new_price</span><span class="p">,</span> <span class="n">new_order_date</span><span class="p">,</span> <span class="n">difference</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">customer_id</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">NULL</span> <span class="k">AS</span> <span class="nb">integer</span><span class="p">),</span> <span class="k">CAST</span><span class="p">(</span><span class="k">NULL</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">),</span> <span class="n">price</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span>
    <span class="k">FROM</span>
        <span class="n">project</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">orders</span>
    <span class="k">WHERE</span>
        <span class="n">id</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span>
        <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
        <span class="k">CASE</span> 
            <span class="k">WHEN</span> <span class="n">o</span><span class="p">.</span><span class="n">price</span><span class="o">&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">new_price</span> <span class="k">THEN</span> <span class="n">t</span><span class="p">.</span><span class="n">new_price</span>
            <span class="k">ELSE</span> <span class="k">NULL</span>
        <span class="k">END</span> <span class="k">AS</span> <span class="n">old_price</span><span class="p">,</span> 
        <span class="n">t</span><span class="p">.</span><span class="n">new_order_date</span> <span class="k">AS</span> <span class="n">old_order_date</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">price</span> <span class="k">AS</span> <span class="n">new_price</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">order_date</span> <span class="k">AS</span> <span class="n">new_order_date</span><span class="p">,</span> 
        <span class="n">t</span><span class="p">.</span><span class="n">new_price</span><span class="o">-</span><span class="n">o</span><span class="p">.</span><span class="n">price</span> <span class="k">AS</span> <span class="n">difference</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>
    <span class="k">FROM</span>
        <span class="n">project</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">t</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
                                        <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">customer_id</span> 
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span> 
<span class="k">FROM</span> <span class="n">t</span> 
<span class="k">WHERE</span> <span class="n">old_price</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">new_order_date</span><span class="p">;</span>
</pre></div></li><li><p>Trino</p><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">memory</span><span class="p">.</span><span class="ss">&quot;default&quot;</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">memory</span><span class="p">.</span><span class="ss">&quot;default&quot;</span><span class="p">.</span><span class="n">orders</span> <span class="k">AS</span> 
<span class="k">SELECT</span> <span class="o">*</span><span class="p">,</span>
       <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">order_date</span><span class="p">)</span> <span class="k">AS</span> <span class="n">id</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">VALUES</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-11&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-12&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">200</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-13&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">8</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-14&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-15&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-16&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>  <span class="mi">50</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-17&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-18&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;2020-05-20&#39;</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">),</span>   <span class="mi">3</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="n">price</span><span class="p">);</span>

<span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">t</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">old_price</span><span class="p">,</span> <span class="n">old_order_date</span><span class="p">,</span> <span class="n">new_price</span><span class="p">,</span> <span class="n">new_order_date</span><span class="p">,</span> <span class="n">difference</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="n">customer_id</span><span class="p">,</span> <span class="k">CAST</span><span class="p">(</span><span class="k">NULL</span> <span class="k">AS</span> <span class="nb">integer</span><span class="p">),</span> <span class="k">CAST</span><span class="p">(</span><span class="k">NULL</span> <span class="k">AS</span> <span class="nb">date</span><span class="p">),</span> <span class="n">price</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span>
    <span class="k">FROM</span>
        <span class="n">memory</span><span class="p">.</span><span class="ss">&quot;default&quot;</span><span class="p">.</span><span class="n">orders</span>
    <span class="k">WHERE</span>
        <span class="n">id</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span>
        <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
        <span class="k">CASE</span> 
            <span class="k">WHEN</span> <span class="n">o</span><span class="p">.</span><span class="n">price</span><span class="o">&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">new_price</span> <span class="k">THEN</span> <span class="n">t</span><span class="p">.</span><span class="n">new_price</span>
            <span class="k">ELSE</span> <span class="k">NULL</span>
        <span class="k">END</span> <span class="k">AS</span> <span class="n">old_price</span><span class="p">,</span> 
        <span class="n">t</span><span class="p">.</span><span class="n">new_order_date</span> <span class="k">AS</span> <span class="n">old_order_date</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">price</span> <span class="k">AS</span> <span class="n">new_price</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">order_date</span> <span class="k">AS</span> <span class="n">new_order_date</span><span class="p">,</span> 
        <span class="n">t</span><span class="p">.</span><span class="n">new_price</span><span class="o">-</span><span class="n">o</span><span class="p">.</span><span class="n">price</span> <span class="k">AS</span> <span class="n">difference</span><span class="p">,</span>
        <span class="n">o</span><span class="p">.</span><span class="n">id</span>
    <span class="k">FROM</span>
        <span class="n">memory</span><span class="p">.</span><span class="ss">&quot;default&quot;</span><span class="p">.</span><span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">t</span> <span class="k">ON</span> <span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="o">+</span><span class="mi">1</span>
                                            <span class="k">AND</span> <span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">customer_id</span> 
<span class="p">)</span>
<span class="k">SELECT</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span> 
<span class="k">FROM</span> <span class="n">t</span> 
<span class="k">WHERE</span> <span class="n">old_price</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">new_order_date</span><span class="p">;</span>
</pre></div></li></ul><h2>Match recognize SQL statement</h2><p>There is one Trino sample. SQL Server 2019 doesn't support it.</p><p>Match recognize clause is aimed to identify patterns in a sequence of rows with regular expressions.</p><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">orders</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">order_date</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span><span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-11&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-12&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-13&#39;</span><span class="p">,</span>   <span class="mi">8</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-14&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-15&#39;</span><span class="p">,</span>   <span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-16&#39;</span><span class="p">,</span>  <span class="mi">50</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_1&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-17&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-18&#39;</span><span class="p">,</span>   <span class="mi">6</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cust_2&#39;</span><span class="p">,</span> <span class="nb">DATE</span> <span class="s1">&#39;2020-05-20&#39;</span><span class="p">,</span>   <span class="mi">3</span><span class="p">))</span>
<span class="k">SELECT</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">old_price</span><span class="p">,</span> <span class="n">old_price_date</span><span class="p">,</span> <span class="n">new_price</span><span class="p">,</span> <span class="n">price_decrease_date</span><span class="p">,</span> <span class="n">old_price</span><span class="o">-</span><span class="n">new_price</span> <span class="k">AS</span> <span class="n">difference</span>
    <span class="k">FROM</span> <span class="n">orders</span>
        <span class="n">MATCH_RECOGNIZE</span> <span class="p">(</span>
            <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">customer_id</span>
            <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">order_date</span>
            <span class="n">MEASURES</span>
                <span class="n">PREV</span><span class="p">(</span><span class="n">DOWN</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">old_price</span><span class="p">,</span>
                <span class="n">PREV</span><span class="p">(</span><span class="n">DOWN</span><span class="p">.</span><span class="n">order_date</span><span class="p">)</span> <span class="k">AS</span> <span class="n">old_price_date</span><span class="p">,</span>
                <span class="k">LAST</span><span class="p">(</span><span class="n">DOWN</span><span class="p">.</span><span class="n">price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">new_price</span><span class="p">,</span>
                <span class="n">DOWN</span><span class="p">.</span><span class="n">order_date</span> <span class="k">AS</span> <span class="n">price_decrease_date</span>
            <span class="k">ALL</span> <span class="k">ROWS</span> <span class="n">PER</span> <span class="k">MATCH</span>
            <span class="k">AFTER</span> <span class="k">MATCH</span> <span class="n">SKIP</span> <span class="n">PAST</span> <span class="k">LAST</span> <span class="k">ROW</span>
            <span class="n">PATTERN</span> <span class="p">(</span><span class="n">DOWN</span><span class="o">+</span><span class="p">)</span>
            <span class="n">DEFINE</span>
                <span class="n">DOWN</span> <span class="k">AS</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">PREV</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">price_decrease_date</span><span class="p">;</span>
</pre></div><h2>Resources</h2><ul><li><a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/cursors-transact-sql?view=sql-server-ver15">Cursors (Transact-SQL)</a></li><li><a href="https://docs.microsoft.com/en-us/sql/t-sql/queries/with-common-table-expression-transact-sql?view=sql-server-ver15">WITH common_table_expression (Transact-SQL)</a></li><li><a href="https://trino.io/docs/current/sql/select.html#with-recursive-clause">Trino with recursive clause</a></li><li><a href="https://trino.io/docs/current/sql/match-recognize.html#sql-match-recognize--page-root">Trino match recognize</a></li><li><a href="https://trino.io/blog/2021/05/19/row_pattern_matching.html">Trino row pattern recognition with MATCH_RECOGNIZE</a></li></ul></div><hr><section class="comments" id="comments"><h2>Comments</h2><div id="disqus_thread"></div><script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'techjogging'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2022-02-19-evolution-sql-language-price-decline-data-transformation-trino-sqlserver';
                        this.page.url = 'https://techjogging.com/evolution-sql-language-price-decline-data-transformation-trino-sqlserver.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></article></section></div><div class="col-sm-3" id="sidebar"><aside><section class="well well-sm"><ul class="list-group list-group-flush"><li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4><ul class="list-group" id="recentposts"><li class="list-group-item"><a href="https://techjogging.com/hubitat-sensor-logging-visualization-synology-nas.html">Hubitat Sensor Logging Visualization in Synology NAS</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-float-data-type.html">COBOL Float Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-decimal-data-type.html">COBOL Decimal Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-display-decimal-data-type.html">COBOL Display Decimal Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-character-data-type.html">COBOL Character Data Type</a></li></ul></li><li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4><ul class="list-group" id="categories"><li class="list-group-item"><a href="https://techjogging.com/category/cobol.html"><i class="fa fa-folder-open fa-lg"></i>COBOL</a></li><li class="list-group-item"><a href="https://techjogging.com/category/cron.html"><i class="fa fa-folder-open fa-lg"></i>Cron</a></li><li class="list-group-item"><a href="https://techjogging.com/category/dbeaver.html"><i class="fa fa-folder-open fa-lg"></i>DBeaver</a></li><li class="list-group-item"><a href="https://techjogging.com/category/docker.html"><i class="fa fa-folder-open fa-lg"></i>Docker</a></li><li class="list-group-item"><a href="https://techjogging.com/category/git.html"><i class="fa fa-folder-open fa-lg"></i>Git</a></li><li class="list-group-item"><a href="https://techjogging.com/category/google-analytics.html"><i class="fa fa-folder-open fa-lg"></i>Google Analytics</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hardware.html"><i class="fa fa-folder-open fa-lg"></i>Hardware</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hive.html"><i class="fa fa-folder-open fa-lg"></i>Hive</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hubitat.html"><i class="fa fa-folder-open fa-lg"></i>Hubitat</a></li><li class="list-group-item"><a href="https://techjogging.com/category/kerberos.html"><i class="fa fa-folder-open fa-lg"></i>Kerberos</a></li><li class="list-group-item"><a href="https://techjogging.com/category/linux.html"><i class="fa fa-folder-open fa-lg"></i>Linux</a></li><li class="list-group-item"><a href="https://techjogging.com/category/microsoft-access.html"><i class="fa fa-folder-open fa-lg"></i>Microsoft Access</a></li><li class="list-group-item"><a href="https://techjogging.com/category/microsoft-excel.html"><i class="fa fa-folder-open fa-lg"></i>Microsoft Excel</a></li><li class="list-group-item"><a href="https://techjogging.com/category/minio.html"><i class="fa fa-folder-open fa-lg"></i>MinIO</a></li><li class="list-group-item"><a href="https://techjogging.com/category/ms-sql-server.html"><i class="fa fa-folder-open fa-lg"></i>MS SQL Server</a></li><li class="list-group-item"><a href="https://techjogging.com/category/nginx.html"><i class="fa fa-folder-open fa-lg"></i>Nginx</a></li><li class="list-group-item"><a href="https://techjogging.com/category/python.html"><i class="fa fa-folder-open fa-lg"></i>Python</a></li><li class="list-group-item"><a href="https://techjogging.com/category/security.html"><i class="fa fa-folder-open fa-lg"></i>Security</a></li><li class="list-group-item"><a href="https://techjogging.com/category/surveillance.html"><i class="fa fa-folder-open fa-lg"></i>Surveillance</a></li><li class="list-group-item"><a href="https://techjogging.com/category/synology-dsm.html"><i class="fa fa-folder-open fa-lg"></i>Synology DSM</a></li><li class="list-group-item"><a href="https://techjogging.com/category/talend.html"><i class="fa fa-folder-open fa-lg"></i>Talend</a></li><li class="list-group-item"><a href="https://techjogging.com/category/trinopresto.html"><i class="fa fa-folder-open fa-lg"></i>Trino(Presto)</a></li><li class="list-group-item"><a href="https://techjogging.com/category/virtualization.html"><i class="fa fa-folder-open fa-lg"></i>Virtualization</a></li><li class="list-group-item"><a href="https://techjogging.com/category/windows.html"><i class="fa fa-folder-open fa-lg"></i>Windows</a></li></ul></li></ul></section></aside></div></div></div><footer><div class="container"><hr><div class="row"><div class="col-xs-10">&copy; 2022 Vitaly Saversky &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>, <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>, <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></div><div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i><a href="#">Back to top</a></p></div></div></div></footer><script src="https://techjogging.com/theme/js/jquery.min.js"></script><script src="https://techjogging.com/theme/js/bootstrap.min.js"></script><script src="https://techjogging.com/theme/js/respond.min.js"></script><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'techjogging'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script><script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-156524189-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script><script src="https://techjogging.com/theme/js/report_access.js"></script><script type="text/javascript">
(function(w,d,s,g,js,fs){
  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
  js.src='https://apis.google.com/js/platform.js';
  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
}(window,document,'script'));
</script><script type="text/javascript">
gapi.analytics.ready(function() {

	  gapi.analytics.auth.authorize({
	    'serverAuth': {
	      'access_token': ANALYTICS_TOKEN
	    }
	  });
	  
	  var pagePathFilter = 'ga:pagePath==' + window.location.pathname;
	  
	  var report = new gapi.analytics.report.Data({
		  query: {
		    ids: 'ga:209816969',
		    'start-date': '2020-02-29',
		    'end-date': 'today',
		    metrics: 'ga:pageviews',
		    filters: pagePathFilter
		  }
		});

		report.on('success', function(response) {
			pageViews = response.totalsForAllResults['ga:pageviews'];
			if (pageViews!='0') {
				$('#query-output').text(pageViews);
				for (pageviewsElement of document.getElementsByClassName('pageviews')){
					pageviewsElement.style.display='initial';
				}
			}
		});

		report.execute();

	  
	});
</script></body></html>