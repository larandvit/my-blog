<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml"><head><title>Access SQL Server with Trusted Connection in Linux with Python Using Kerberos Ticket - tech jogging</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="A personal blog includes technical articles aimed to share knowledge and experience with others."><link rel="canonical" href="https://techjogging.com/access-sqlserver-windows-trusted-connection-linux-python.html"><meta name="author" content="Vitaly Saversky"><meta name="description" content="Integration of Windows and Linux environments is common in many companies. One of the scenarios is when Windows Active Directory serves for user authentication and Linux servers or containers are used for running applications. Also, MS SQL Server is utilized for storing data. There are some ways to connect to …"><meta property="og:site_name" content="tech jogging"><meta property="og:type" content="article"><meta property="og:title" content="Access SQL Server with Trusted Connection in Linux with Python Using Kerberos Ticket"><meta property="og:url" content="https://techjogging.com/access-sqlserver-windows-trusted-connection-linux-python.html"><meta property="og:description" content="Integration of Windows and Linux environments is common in many companies. One of the scenarios is when Windows Active Directory serves for user authentication and Linux servers or containers are used for running applications. Also, MS SQL Server is utilized for storing data. There are some ways to connect to …"><meta property="article:published_time" content="2021-08-15"><meta property="article:section" content="Python"><meta property="article:author" content="Vitaly Saversky"><link rel="stylesheet" href="https://techjogging.com/theme/css/bootstrap.flatly.min.css" type="text/css"><link href="https://techjogging.com/theme/css/font-awesome.min.css" rel="stylesheet"><link href="https://techjogging.com/theme/css/pygments/monokai.css" rel="stylesheet"><link href="https://techjogging.com/theme/tipuesearch/tipuesearch.css" rel="stylesheet"><link rel="stylesheet" href="https://techjogging.com/theme/css/style.css" type="text/css"></head><body><div class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="https://techjogging.com/" class="navbar-brand"><img alt="tech jogging" class="img-responsive pull-left gap-right" src="https://techjogging.com/extra/site-logo.png" width> tech jogging </a></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li><a href="https://techjogging.com/pages/about-blog.html"> About blog </a></li></ul><ul class="nav navbar-nav navbar-right"><li><span><form class="navbar-search" action="/search.html"><input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" pattern=".{3,}" title="At least 3 characters" required><button type="submit" class="tipue_search_button"><div class="tipue_search_icon">&#9906;</div></button></form></span></li></ul></div></div></div><div class="container"><div class="row"><div class="col-sm-9"><section id="content"><article><header class="page-header"><h1><a href="https://techjogging.com/access-sqlserver-windows-trusted-connection-linux-python.html" rel="bookmark" title="Permalink to Access SQL Server with Trusted Connection in Linux with Python Using Kerberos Ticket"> Access SQL Server with Trusted Connection in Linux with Python Using Kerberos Ticket </a></h1></header><div class="entry-content"><div class="panel"><div class="panel-body"><footer class="post-info"><span class="label label-default">Date</span><span class="published article-info-label"><i class="fa fa-calendar"></i><time datetime="2021-08-15T00:00:00-04:00"> 2021-08-15</time></span><span class="label label-default">Modified</span><span class="modified article-info-label"><i class="fa fa-calendar"></i><time datetime="2021-09-30T00:00:00-04:00"> 2021-09-30</time></span><span class="label label-default pageviews">Views</span><span class="article-info-label pageviews"><span class="badge pageviews" id="query-output"></span></span><span class="label label-default">Category</span><span class="article-info-label"><a href="https://techjogging.com/category/python.html">Python</a>, <a href="https://techjogging.com/category/ms-sql-server.html">MS SQL Server</a>, <a href="https://techjogging.com/category/kerberos.html">Kerberos</a></span></footer></div></div><p>Integration of Windows and Linux environments is common in many companies. One of the scenarios is when Windows Active Directory serves for user authentication and Linux servers or containers are used for running applications. Also, MS SQL Server is utilized for storing data. There are some ways to connect to MS SQL Server in that case. </p><p>The first method is the traditional one to access to a SQL Server data with a SQL Server account. It is an easy way which does not request any special efforts. The second way is more complicated with using a kerberized Active Directory account and Windows trusted connection to SQL Server. We need to create a Kerberos keytab which contains Windows service account credentials and generate a Kerberos ticket based on the Kerberos keytab. This method might not work if we want to know who access our SQL Server data as each user is going to connect to SQL Server with the same Windows service account. </p><p>Let's try to supply our applications with the current user Windows credentials for accessing of SQL Server data. Our issue is that Python data access libraries are fed with SQL Server accounts or access data with Windows trusted connection. Windows trusted connection works perfectly in Windows but Linux environment behaves differently.</p><p>To achieve access to SQL Server with user Windows credentials, we follow the steps.</p><ol><li>Receive Windows user name and password.</li><li>Create a Kerberos ticket.</li><li>Access data with Windows trusted connection.</li></ol><p>You need to think how to pass user credentials in your application pipeline safely without compromising it. It might be many moving parts with possibility of revealing those credentials.</p><p>The sample code is developed in CentOS 7 with Python 3 and pyodbc library. </p><h2>Prerequisites</h2><ul><li><p>Install Kerberos client.</p><div class="highlight"><pre><span></span>sudo yum install krb5-workstation krb5-libs
</pre></div></li><li><p>Install ODBC on non MS Windows platforms.</p><div class="highlight"><pre><span></span>sudo yum install unixODBC-devel
</pre></div></li><li><p>Install Microsoft ODBC driver for SQL Server.</p><p>The sample uses ODBC driver version 13 but the latest version is 17. </p><div class="highlight"><pre><span></span>sudo rpm -i https://packages.microsoft.com/rhel/7/prod/msodbcsql-13.1.9.2-1.x86_64.rpm
</pre></div><p>If you decide for the latest ODBC driver, get one from <a href="https://docs.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server">Download ODBC Driver for SQL Server</a>.</p></li><li><p>Install Python pyodbc library</p><div class="highlight"><pre><span></span>pip install pyodbc
</pre></div></li></ul><h2>Sample</h2><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyodbc</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="k">def</span> <span class="nf">create_kerberos_ticket</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">,</span> <span class="n">user_password</span><span class="p">):</span>

    <span class="n">ssh</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;kinit&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{user_name}</span><span class="s1">@</span><span class="si">{domain_name}</span><span class="s1">&#39;</span><span class="p">],</span>
                        <span class="n">stdin</span> <span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ssh</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{user_password}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ssh</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;exit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ssh</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sqlserver_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;Driver={ODBC Driver 13 for SQL Server}&#39;</span> <span class="o">+</span> \
                          <span class="s1">&#39;;Server=&#39;</span> <span class="o">+</span> <span class="s1">&#39;sqlserver.sample.com&#39;</span> <span class="o">+</span> \
                          <span class="s1">&#39;;Database=&#39;</span> <span class="o">+</span> <span class="s1">&#39;sample_database&#39;</span> <span class="o">+</span> \
                          <span class="s1">&#39;;Trusted_Connection=yes&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">user_name</span> <span class="o">=</span> <span class="s1">&#39;sampleuser&#39;</span>
    <span class="n">user_password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Enter </span><span class="si">{user_name}</span><span class="s1"> Windows password: &#39;</span><span class="p">)</span>
    <span class="n">domain_name</span> <span class="o">=</span> <span class="s1">&#39;SAMPLE.COM&#39;</span>

    <span class="n">create_kerberos_ticket</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">,</span> <span class="n">user_password</span><span class="p">)</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="n">sqlserver_connection</span><span class="p">()</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">sql_text</span> <span class="o">=</span> <span class="s1">&#39;SELECT @@VERSION&#39;</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_text</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div><h2>Troubleshooting</h2><ul><li><p>Error message</p><div class="highlight"><pre><span></span>pyodbc.Error: (&#39;HY000&#39;, &#39;[HY000] [unixODBC][Microsoft][ODBC Driver 13 for SQL Server]SSPI Provider: No Kerberos credentials available (default cache: FILE:/tmp/krb5cc_1000) (851968) (SQLDriverConnect)&#39;)
</pre></div><p>One of the reasons is incorrect password. In that case, a Kerberos ticket is not created.</p></li><li><p>Check Kerberos ticket(s) created by an application. Open terminal and run commands.</p><div class="highlight"><pre><span></span>klist
</pre></div></li><li><p>Missing Kerberos ticket cache file variable.</p><p>It might be requested to create <code>KRB5CCNAME</code> variable with location and name of Kerberos ticket cache file. See more details in <a href="https://techjogging.com/create-ticket-cache-kerberos-authentication-linux.html">Create Ticket Cache File for Kerberos Authentication in Linux </a> article.</p></li><li><p>Missing krb5.conf Kerberos configuration file. </p><p>The file contains default realm and Kerberos ticket settings. See more details in <a href="https://techjogging.com/create-ticket-cache-kerberos-authentication-linux.html">Create Ticket Cache File for Kerberos Authentication in Linux </a> article.</p></li></ul><h2>Resources</h2><ul><li><a href="https://github.com/mkleehammer/pyodbc">pyodbc</a></li><li><a href="https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/kinit.html">kinit - MIT Kerberos Documentation</a></li><li><a href="https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/klist.html">klist - MIT Kerberos Documentation</a></li><li><a href="https://janakiev.com/blog/python-shell-commands/">How to Execute Shell Commands with Python</a></li><li><a href="https://docs.microsoft.com/en-us/sql/connect/odbc/microsoft-odbc-driver-for-sql-server">Microsoft ODBC Driver for SQL Server</a></li><li><a href="https://techjogging.com/create-ticket-cache-kerberos-authentication-linux.html">Create Ticket Cache File for Kerberos Authentication in Linux </a></li></ul></div><hr><section class="comments" id="comments"><h2>Comments</h2><div id="disqus_thread"></div><script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'techjogging'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2021-08-15-access-sqlserver-windows-trusted-connection-linux-python';
                        this.page.url = 'https://techjogging.com/access-sqlserver-windows-trusted-connection-linux-python.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></article></section></div><div class="col-sm-3" id="sidebar"><aside><section class="well well-sm"><ul class="list-group list-group-flush"><li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4><ul class="list-group" id="recentposts"><li class="list-group-item"><a href="https://techjogging.com/cobol-decimal-data-type.html">COBOL Decimal Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-character-data-type.html">COBOL Character Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-unsigned-binary-data-type.html">COBOL Unsigned BINARY Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-signed-binary-data-type.html">COBOL Signed BINARY Data Type</a></li><li class="list-group-item"><a href="https://techjogging.com/cobol-data-types.html">COBOL Data Types</a></li></ul></li><li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Categories</span></h4><ul class="list-group" id="categories"><li class="list-group-item"><a href="https://techjogging.com/category/cobol.html"><i class="fa fa-folder-open fa-lg"></i>COBOL</a></li><li class="list-group-item"><a href="https://techjogging.com/category/cron.html"><i class="fa fa-folder-open fa-lg"></i>Cron</a></li><li class="list-group-item"><a href="https://techjogging.com/category/dbeaver.html"><i class="fa fa-folder-open fa-lg"></i>DBeaver</a></li><li class="list-group-item"><a href="https://techjogging.com/category/docker.html"><i class="fa fa-folder-open fa-lg"></i>Docker</a></li><li class="list-group-item"><a href="https://techjogging.com/category/git.html"><i class="fa fa-folder-open fa-lg"></i>Git</a></li><li class="list-group-item"><a href="https://techjogging.com/category/google-analytics.html"><i class="fa fa-folder-open fa-lg"></i>Google Analytics</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hardware.html"><i class="fa fa-folder-open fa-lg"></i>Hardware</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hive.html"><i class="fa fa-folder-open fa-lg"></i>Hive</a></li><li class="list-group-item"><a href="https://techjogging.com/category/hubitat.html"><i class="fa fa-folder-open fa-lg"></i>Hubitat</a></li><li class="list-group-item"><a href="https://techjogging.com/category/kerberos.html"><i class="fa fa-folder-open fa-lg"></i>Kerberos</a></li><li class="list-group-item"><a href="https://techjogging.com/category/linux.html"><i class="fa fa-folder-open fa-lg"></i>Linux</a></li><li class="list-group-item"><a href="https://techjogging.com/category/microsoft-access.html"><i class="fa fa-folder-open fa-lg"></i>Microsoft Access</a></li><li class="list-group-item"><a href="https://techjogging.com/category/microsoft-excel.html"><i class="fa fa-folder-open fa-lg"></i>Microsoft Excel</a></li><li class="list-group-item"><a href="https://techjogging.com/category/minio.html"><i class="fa fa-folder-open fa-lg"></i>MinIO</a></li><li class="list-group-item"><a href="https://techjogging.com/category/ms-sql-server.html"><i class="fa fa-folder-open fa-lg"></i>MS SQL Server</a></li><li class="list-group-item"><a href="https://techjogging.com/category/nginx.html"><i class="fa fa-folder-open fa-lg"></i>Nginx</a></li><li class="list-group-item"><a href="https://techjogging.com/category/python.html"><i class="fa fa-folder-open fa-lg"></i>Python</a></li><li class="list-group-item"><a href="https://techjogging.com/category/security.html"><i class="fa fa-folder-open fa-lg"></i>Security</a></li><li class="list-group-item"><a href="https://techjogging.com/category/surveillance.html"><i class="fa fa-folder-open fa-lg"></i>Surveillance</a></li><li class="list-group-item"><a href="https://techjogging.com/category/synology-dsm.html"><i class="fa fa-folder-open fa-lg"></i>Synology DSM</a></li><li class="list-group-item"><a href="https://techjogging.com/category/talend.html"><i class="fa fa-folder-open fa-lg"></i>Talend</a></li><li class="list-group-item"><a href="https://techjogging.com/category/trinopresto.html"><i class="fa fa-folder-open fa-lg"></i>Trino(Presto)</a></li><li class="list-group-item"><a href="https://techjogging.com/category/virtualization.html"><i class="fa fa-folder-open fa-lg"></i>Virtualization</a></li><li class="list-group-item"><a href="https://techjogging.com/category/windows.html"><i class="fa fa-folder-open fa-lg"></i>Windows</a></li></ul></li></ul></section></aside></div></div></div><footer><div class="container"><hr><div class="row"><div class="col-xs-10">&copy; 2022 Vitaly Saversky &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>, <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>, <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></div><div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i><a href="#">Back to top</a></p></div></div></div></footer><script src="https://techjogging.com/theme/js/jquery.min.js"></script><script src="https://techjogging.com/theme/js/bootstrap.min.js"></script><script src="https://techjogging.com/theme/js/respond.min.js"></script><script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'techjogging'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script><script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-156524189-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script><script src="https://techjogging.com/theme/js/report_access.js"></script><script type="text/javascript">
(function(w,d,s,g,js,fs){
  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
  js.src='https://apis.google.com/js/platform.js';
  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
}(window,document,'script'));
</script><script type="text/javascript">
gapi.analytics.ready(function() {

	  gapi.analytics.auth.authorize({
	    'serverAuth': {
	      'access_token': ANALYTICS_TOKEN
	    }
	  });
	  
	  var pagePathFilter = 'ga:pagePath==' + window.location.pathname;
	  
	  var report = new gapi.analytics.report.Data({
		  query: {
		    ids: 'ga:209816969',
		    'start-date': '2020-02-29',
		    'end-date': 'today',
		    metrics: 'ga:pageviews',
		    filters: pagePathFilter
		  }
		});

		report.on('success', function(response) {
			pageViews = response.totalsForAllResults['ga:pageviews'];
			if (pageViews!='0') {
				$('#query-output').text(pageViews);
				for (pageviewsElement of document.getElementsByClassName('pageviews')){
					pageviewsElement.style.display='initial';
				}
			}
		});

		report.execute();

	  
	});
</script></body></html>